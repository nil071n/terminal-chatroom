<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Terminal Chatroom</title>
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0a;
    --panel: #111;
    --border: #2a2a2a;
    --text: #c8c8c8;
    --green: #00ff41;
    --dim-green: #00aa2a;
    --cyan: #00d4ff;
    --yellow: #ffcc00;
    --red: #ff3333;
    --purple: #c084fc;
    --dim: #555;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
    font-size: 14px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── Header ── */
  .header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 8px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .header-title {
    color: var(--green);
    font-weight: bold;
    font-size: 15px;
    letter-spacing: 1px;
  }
  .header-status {
    font-size: 12px;
    color: var(--dim);
  }
  .header-status .dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--red);
    margin-right: 6px;
    vertical-align: middle;
  }
  .header-status .dot.online { background: var(--green); }

  /* ── Layout ── */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── Sidebar ── */
  .sidebar {
    width: 180px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }
  .sidebar-title {
    padding: 10px 12px 6px;
    color: var(--dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .user-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 12px;
  }
  .user-item {
    padding: 3px 0;
    color: var(--cyan);
    font-size: 13px;
  }
  .user-item::before {
    content: '> ';
    color: var(--dim);
  }

  /* ── Chat area ── */
  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    scroll-behavior: smooth;
  }
  .messages::-webkit-scrollbar { width: 6px; }
  .messages::-webkit-scrollbar-track { background: var(--bg); }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .msg { padding: 3px 0; line-height: 1.5; word-wrap: break-word; }
  .msg .time { color: var(--dim); font-size: 12px; margin-right: 6px; }
  .msg .user { font-weight: bold; margin-right: 4px; }
  .msg.system { color: var(--dim); font-style: italic; }
  .msg.system .label { color: var(--yellow); font-style: normal; }
  .msg.action { color: var(--purple); font-style: italic; }
  .msg.error { color: var(--red); }
  .msg.self .user { color: var(--green); }
  .msg.other .user { color: var(--cyan); }

  /* ── Input ── */
  .input-bar {
    display: flex;
    align-items: center;
    background: var(--panel);
    border-top: 1px solid var(--border);
    padding: 10px 16px;
    flex-shrink: 0;
  }
  .prompt {
    color: var(--green);
    margin-right: 8px;
    font-weight: bold;
    white-space: nowrap;
  }
  .input-bar input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    caret-color: var(--green);
  }

  /* ── Login overlay ── */
  .login-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .login-overlay.hidden { display: none; }
  .login-box {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 32px 40px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
  .login-box h1 {
    color: var(--green);
    font-size: 20px;
    margin-bottom: 4px;
    letter-spacing: 2px;
  }
  .login-box .subtitle {
    color: var(--dim);
    font-size: 12px;
    margin-bottom: 24px;
  }
  .login-box .field {
    display: flex;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 10px 14px;
    margin-bottom: 16px;
  }
  .login-box .field span {
    color: var(--green);
    margin-right: 10px;
  }
  .login-box .field input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    caret-color: var(--green);
  }
  .login-box button {
    background: var(--green);
    color: var(--bg);
    border: none;
    padding: 10px 32px;
    font-family: inherit;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: opacity .15s;
  }
  .login-box button:hover { opacity: 0.85; }
  .login-error {
    color: var(--red);
    font-size: 13px;
    margin-top: 12px;
    min-height: 20px;
  }

  /* ── ASCII art ── */
  .ascii-art {
    color: var(--dim-green);
    font-size: 10px;
    line-height: 1.2;
    margin-bottom: 16px;
    white-space: pre;
  }

  /* ── Responsive ── */
  @media (max-width: 600px) {
    .sidebar { display: none; }
  }
</style>
</head>
<body>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="ascii-art">
 _____ ____ _   _    _  _____
|_   _/ ___| | | |  / \|_   _|
  | || |   | |_| | / _ \ | |
  | || |___|  _  |/ ___ \| |
  |_| \____|_| |_/_/   \_|_|
    </div>
    <h1>TERMINAL CHAT</h1>
    <div class="subtitle">real-time chatroom &mdash; type /help for commands</div>
    <div class="field">
      <span>login&gt;</span>
      <input type="text" id="usernameInput" placeholder="enter username" maxlength="40" autofocus>
    </div>
    <div class="field">
      <span>pass&gt;</span>
      <input type="password" id="passwordInput" placeholder="password" maxlength="100">
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
      <button id="joinBtn">Connect</button>
      <button id="registerBtn">Register</button>
      <button id="openLauncherBtn" style="background:#00d4ff;color:#041018;border:none;padding:10px 18px;cursor:pointer;">Open in Launcher</button>
    </div>
    <div style="margin-top:8px;font-size:12px;color:var(--dim);">If the launcher is not installed, clicking "Open in Launcher" will prompt a download. You can register or login here; the launcher can also obtain tokens.</div>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- App -->
<div class="header">
  <div class="header-title">&gt;_ TERMINAL CHATROOM</div>
  <div class="header-status">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">disconnected</span>
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-title">Online</div>
    <div class="user-list" id="userList"></div>
  </div>

  <div class="chat-container">
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <span class="prompt" id="promptLabel">guest&gt;</span>
      <input type="text" id="chatInput" placeholder="Type a message..." maxlength="500" disabled>
    </div>
  </div>
</div>

<script>
(function() {
  const $ = (s) => document.querySelector(s);

  const loginOverlay = $("#loginOverlay");
  const usernameInput = $("#usernameInput");
  const joinBtn = $("#joinBtn");
  const loginError = $("#loginError");
  const statusDot = $("#statusDot");
  const statusText = $("#statusText");
  const userListEl = $("#userList");
  const messagesEl = $("#messages");
  const chatInput = $("#chatInput");
  const promptLabel = $("#promptLabel");

  let ws = null;
  let myUsername = "";

  // ── Login ──
  async function attemptJoin() {
    const name = usernameInput.value.trim();
    const password = (document.getElementById('passwordInput')||{value:''}).value || '';
    if (!name) {
      loginError.textContent = "Username cannot be empty.";
      return;
    }
    loginError.textContent = "";
    joinBtn.disabled = true;
    joinBtn.textContent = "Connecting...";

    const params = new URLSearchParams(location.search);
    let joinToken = params.get('token');
    try {
      if (!joinToken) {
        // Login to obtain JWT
        const loginRes = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: name, password })
        });
        if (!loginRes.ok) {
          const err = await loginRes.json().catch(()=>({ error: 'login failed' }));
          throw new Error(err.error || 'Login failed');
        }
        const { token: jwt } = await loginRes.json();
        // Exchange JWT for a launcher join token
        const authRes = await fetch('/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + jwt },
          body: JSON.stringify({ pcName: 'web' })
        });
        if (!authRes.ok) {
          const err = await authRes.json().catch(()=>({ error: 'auth failed' }));
          throw new Error(err.error || 'Auth failed');
        }
        const authJson = await authRes.json();
        joinToken = authJson.token;
        params.set('token', joinToken);
        history.replaceState(null, '', location.pathname + '?' + params.toString());
      }

      connect(name);
    } catch (e) {
      loginError.textContent = e.message || 'Failed to connect';
      joinBtn.disabled = false;
      joinBtn.textContent = "Connect";
    }
  }

  joinBtn.addEventListener("click", attemptJoin);
  usernameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") attemptJoin();
  });
  const passwordInputEl = document.getElementById('passwordInput');
  if (passwordInputEl) passwordInputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptJoin(); });

  const registerBtn = document.getElementById('registerBtn');
  if (registerBtn) {
    registerBtn.addEventListener('click', async () => {
      const name = usernameInput.value.trim();
      const password = (document.getElementById('passwordInput')||{value:''}).value || '';
      if (!name || !password) {
        loginError.textContent = 'Provide username and password.';
        return;
      }
      registerBtn.disabled = true; registerBtn.textContent = 'Registering...';
      try {
        const r = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: name, password })
        });
        if (!r.ok) {
          const err = await r.json().catch(()=>({ error: 'register failed' }));
          throw new Error(err.error || 'Register failed');
        }
        loginError.textContent = 'Registered successfully. Click Connect.';
      } catch (e) {
        loginError.textContent = e.message || 'Register failed';
      } finally {
        registerBtn.disabled = false; registerBtn.textContent = 'Register';
      }
    });
  }

  // Open-in-launcher button: tries protocol then falls back to download
  const openLauncherBtn = document.getElementById('openLauncherBtn');
  if (openLauncherBtn) {
    openLauncherBtn.addEventListener('click', () => {
      const url = 'chatroom://connect?server=' + encodeURIComponent(location.origin);
      const start = Date.now();
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      // try to trigger protocol handler
      try { iframe.src = url; } catch (e) { /* ignore */ }
      // if not handled quickly, redirect to download
      setTimeout(() => {
        try { document.body.removeChild(iframe); } catch (e) {}
        if (Date.now() - start < 1500) {
          window.location.href = 'https://github.com/nil071n/Launcher/releases/latest/download/chatroom-launcher.exe';
        }
      }, 1200);
    });
  }

  // ── WebSocket ──
  function connect(username) {
    const token = new URLSearchParams(location.search).get('token');
    if (!token) {
      loginError.textContent = "Launcher token required.";
      joinBtn.disabled = false;
      joinBtn.textContent = 'Connect';
      return;
    }
    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/?token=${encodeURIComponent(token)}`);

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", username }));
    };

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      handleMessage(msg, username);
    };

    ws.onclose = () => {
      setStatus(false);
      chatInput.disabled = true;
      addSystemMsg("Connection lost. Refresh to reconnect.");
    };

    ws.onerror = () => {
      loginError.textContent = "Connection failed.";
      joinBtn.disabled = false;
      joinBtn.textContent = "Connect";
    };
  }

  function handleMessage(msg, pendingUsername) {
    switch (msg.type) {
      case "history":
        // Successfully joined
        myUsername = pendingUsername;
        loginOverlay.classList.add("hidden");
        chatInput.disabled = false;
        chatInput.focus();
        promptLabel.textContent = myUsername + ">";
        setStatus(true);
        // Render history
        msg.messages.forEach((m) => renderMsg(m));
        scrollBottom();
        break;

      case "chat":
        renderMsg(msg);
        scrollBottom();
        break;

      case "system":
        renderMsg(msg);
        scrollBottom();
        // Update own prompt if nick changed
        if (msg.message.includes("is now known as")) {
          const parts = msg.message.split(" is now known as ");
          if (parts[0] === myUsername) {
            myUsername = parts[1];
            promptLabel.textContent = myUsername + ">";
          }
        }
        break;

      case "action":
        renderMsg(msg);
        scrollBottom();
        break;

      case "error":
        if (loginOverlay.classList.contains("hidden")) {
          addErrorMsg(msg.message);
        } else {
          loginError.textContent = msg.message;
          joinBtn.disabled = false;
          joinBtn.textContent = "Connect";
        }
        break;

      case "users":
        renderUsers(msg.list);
        break;

      case "clear":
        messagesEl.innerHTML = "";
        break;
    }
  }

  // ── Rendering ──
  function renderMsg(msg) {
    const el = document.createElement("div");
    el.classList.add("msg");

    const time = msg.time ? `<span class="time">[${msg.time}]</span>` : "";

    if (msg.type === "chat") {
      const isSelf = msg.username === myUsername;
      el.classList.add(isSelf ? "self" : "other");
      el.innerHTML = `${time}<span class="user">${esc(msg.username)}:</span> ${esc(msg.text)}`;
    } else if (msg.type === "system") {
      el.classList.add("system");
      el.innerHTML = `${time}<span class="label">*** </span>${esc(msg.message)}`;
    } else if (msg.type === "action") {
      el.classList.add("action");
      el.innerHTML = `${time}* ${esc(msg.message)}`;
    }

    messagesEl.appendChild(el);
  }

  function addSystemMsg(text) {
    const el = document.createElement("div");
    el.classList.add("msg", "system");
    el.innerHTML = `<span class="label">*** </span>${esc(text)}`;
    messagesEl.appendChild(el);
    scrollBottom();
  }

  function addErrorMsg(text) {
    const el = document.createElement("div");
    el.classList.add("msg", "error");
    el.innerHTML = `<span style="font-weight:bold">ERR:</span> ${esc(text)}`;
    messagesEl.appendChild(el);
    scrollBottom();
  }

  function renderUsers(list) {
    userListEl.innerHTML = list.map((u) =>
      `<div class="user-item">${esc(u)}</div>`
    ).join("");
  }

  function scrollBottom() {
    requestAnimationFrame(() => {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  function setStatus(online) {
    statusDot.classList.toggle("online", online);
    statusText.textContent = online ? "connected" : "disconnected";
  }

  function esc(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // ── Chat input ──
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && chatInput.value.trim()) {
      ws.send(JSON.stringify({ type: "chat", text: chatInput.value }));
      chatInput.value = "";
    }
  });
})();
</script>
</body>
</html>
